<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Transcript Annotation Tool - V5 (High Contrast)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f7f6; color: #000; }
        .container { max-width: 1600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .guideline-section { margin-bottom: 25px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; }
        .guideline-header { background: #607d8b; color: white; padding: 10px 15px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; }
        .guideline-content { padding: 15px; background: #fff; }
        
        .ref-table { width: 100%; border-collapse: collapse; font-size: 0.85em; margin-bottom: 20px; color: #000; }
        .ref-table th, .ref-table td { border: 1px solid #eee; padding: 8px; text-align: left; }
        .ref-table th { background-color: #f8f9fa; color: #000; position: sticky; top: 0; }

        .step2-box { background-color: #f1f8e9; border: 1px solid #c5e1a5; padding: 15px; border-radius: 4px; color: #000; }
        .definition-box { background-color: #ffffff; border-left: 4px solid #4caf50; padding: 10px 15px; margin: 10px 0; font-size: 0.95em; }
        .definition-term { font-weight: bold; color: #2e7d32; }

        table.main-table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; color: #000; }
        .main-table th, .main-table td { border: 1px solid #ddd; padding: 10px; text-align: left; overflow: hidden; }
        .main-table th { background-color: #4CAF50; color: white; position: sticky; top: 0; z-index: 10; }
        
        /* æ ¸å¿ƒä¿®æ”¹ï¼šæ‰€æœ‰æ¬„ä½å¯¦æ–½ä¸€ç°ä¸€ç™½åº•è‰²ç›¸é–“ */
        tr:nth-child(even) td { background-color: #f9f9f9 !important; }
        tr:nth-child(odd) td { background-color: #ffffff !important; }
        
        /* ç¢ºä¿æ–‡å­—èˆ‡é¸å–®åœ¨é«˜å°æ¯”ä¸‹çš„æ¸…æ™°åº¦ */
        td { color: #000 !important; }
        tr.skip-row td { color: #000 !important; }
        tr.skip-row select:disabled { cursor: not-allowed; background-color: #f0f0f0; color: #000; opacity: 1; }

        .controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        .btn { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold; transition: 0.2s; }
        .btn-upload { background-color: #2196F3; }
        .btn-download { background-color: #f44336; }
        .btn-same { background-color: #ff9800; font-size: 12px; white-space: nowrap; }
        
        .col-id { width: 45px; }
        .col-time { width: 90px; }
        .col-text { width: 35%; } 
        .col-select { width: 140px; }
        .col-ap { width: 170px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Transcript æ¨™è¨»ç³»çµ±</h2>

    <div class="guideline-section">
        <div class="guideline-header" onclick="toggleGuideline()">
            <span>ğŸ“– å®Œæ•´èªªæ˜ (Step 1 Taxonomy & Step 2 Rules)</span>
            <span id="toggleIcon">â–¼ æ”¶åˆ</span>
        </div>
        <div class="guideline-content" id="guidelineContent">
            <p style="font-weight: bold; color: #1565c0;">Step 1: Taxonomy for Video Annotation</p>
            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 20px;">
                <table class="ref-table">
                    <thead>
                        <tr>
                            <th style="width:15%">Category</th>
                            <th style="width:15%">Type</th>
                            <th>Definition according to the Taxonomy</th>
                        </tr>
                    </thead>
                    <tbody id="guidelineBody"></tbody>
                </table>
            </div>

            <p style="font-weight: bold; color: #1565c0;">Step 2: Artefact or Process</p>
            <div class="step2-box">
                ç•¶ STEP1 æ¨™è¨»çš„çµæœç‚º Methodã€Supplementaryã€Explanationã€Descriptionã€Conclusionï¼Œæ­¤æ¬„ä½æ‰æœƒé–‹å•Ÿæ¨™è¨»åŠŸèƒ½
                <div class="definition-box">
                    <span class="definition-term">ARTEFACT :</span>
                </div>
                <div class="definition-box">
                    <span class="definition-term">PROCESS :</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="controls">
        <input type="file" id="upload" accept=".xlsx, .xls" style="display:none">
        <button class="btn btn-upload" onclick="document.getElementById('upload').click()">è®€å– Excel æª”æ¡ˆ</button>
        <button class="btn btn-download" onclick="exportToExcel()">åŒ¯å‡ºæ¨™è¨»çµæœ (.xlsx)</button>
        <span id="fileNameDisplay" style="color: #000;">å°šæœªè®€å–æª”æ¡ˆ</span>
    </div>

    <table id="dataTable" class="main-table">
        <thead>
            <tr>
                <th class="col-id">id</th>
                <th class="col-time">start_time</th>
                <th class="col-time">end_time</th>
                <th class="col-text">text</th>
                <th class="col-select">Category</th>
                <th class="col-select">Type</th>
                <th class="col-ap">artefact_Process</th>
                <th class="col-action">å¿«æ·</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
const fullConfigData = [
    { cat: "Greeting", type: "Opening", def: "Starting remarks and instructor/channel introductions" },
    { cat: "Greeting", type: "Closing", def: "Parting remarks and wrap-up." },
    { cat: "Overview", type: "Goal", def: "Main purpose of the video and its descriptions" },
    { cat: "Overview", type: "Motivation", def: "Reasons or background information on why the video was created" },
    { cat: "Overview", type: "Briefing", def: "Rundown of how the goal will be achieved" },
    { cat: "Method", type: "Subgoal", def: "Objective of a subsection" },
    { cat: "Method", type: "Instruction", def: "Actions that the instructor performs to complete the task" },
    { cat: "Method", type: "Tool", def: "Introduction of materials, software, or equipment used." },
    { cat: "Supplementary", type: "Tip", def: "Additional instructions or information that makes instructions easier, faster, or more efficient" },
    { cat: "Supplementary", type: "Warning", def: "Actions that should be avoided." },
    { cat: "Explanation", type: "Justification", def: "Reasons why the instruction was performed" },
    { cat: "Explanation", type: "Effect", def: "Consequences of the instruction" },
    { cat: "Description", type: "Status", def: "Descriptions of the current state of the target object" },
    { cat: "Description", type: "Context", def: "Descriptions of the method or the setting" },
    { cat: "Description", type: "Tool Specification", def: "Descriptions of the tools and equipment" },
    { cat: "Conclusion", type: "Outcome", def: "Descriptions of the final results of the procedure" },
    { cat: "Conclusion", type: "Reflection", def: "Summary, evaluation, and suggestions for the future about the overall procedure" },
    { cat: "Miscellaneous", type: "Side Note", def: "Personal stories, jokes, user engagement, and advertisements" },
    { cat: "Miscellaneous", type: "Self-promotion", def: "Promotion of the instructor of the channel (i.e. likes, subscription, notification, or donations)" },
    { cat: "Miscellaneous", type: "Bridge", def: "Meaningless phrases or expressions that connect different sections" },
    { cat: "Miscellaneous", type: "Filler", def: "Conventional filler words" }
];

const targetCategories = ["Method", "Supplementary", "Explanation", "Description", "Conclusion"];
const config = {};
fullConfigData.forEach(item => {
    if(!config[item.cat]) config[item.cat] = {};
    config[item.cat][item.type] = item.def;
});

const gBody = document.getElementById('guidelineBody');
fullConfigData.forEach(item => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><b style="color:#000">${item.cat}</b></td><td style="color:#000">${item.type}</td><td style="color:#000">${item.def}</td>`;
    gBody.appendChild(tr);
});

function toggleGuideline() {
    const content = document.getElementById('guidelineContent');
    content.style.display = (content.style.display === "none") ? "block" : "none";
}

let tableData = [];

document.getElementById('upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById('fileNameDisplay').innerText = file.name;
    const reader = new FileReader();
    reader.onload = function(event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        tableData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        renderTable();
    };
    reader.readAsArrayBuffer(file);
});

function renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';

    tableData.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.id = `row-${index}`;
        
        // ä¿®æ”¹ï¼šæ¸²æŸ“åŸºæœ¬è³‡æ–™åˆ—
        tr.innerHTML = `
            <td>${row.id || index + 1}</td>
            <td>${row.start_time || ''}</td>
            <td>${row.end_time || ''}</td>
            <td style="font-size:1em; font-weight:500;">${row.text || ''}</td>
        `;

        const tdCat = document.createElement('td'); 
        const selectCat = document.createElement('select');
        selectCat.innerHTML = `<option value="">è«‹é¸æ“‡</option>` + 
            Object.keys(config).map(cat => `<option value="${cat}" ${row.Category === cat ? 'selected' : ''}>${cat}</option>`).join('');
        
        const tdType = document.createElement('td'); 
        const selectType = document.createElement('select');
        const tdAP = document.createElement('td'); 
        const selectAP = document.createElement('select');

        const updateAPStatus = (selectedCat) => {
            const isTarget = targetCategories.includes(selectedCat);
            if (!isTarget) {
                selectAP.disabled = true;
                selectAP.innerHTML = '<option value="">-</option>';
                row.artefact_Process = "";
                tr.classList.add('skip-row');
            } else {
                selectAP.disabled = false;
                tr.classList.remove('skip-row');
                selectAP.innerHTML = `
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="ARTEFACT" ${row.artefact_Process === 'ARTEFACT' ? 'selected' : ''}>ARTEFACT</option>
                    <option value="PROCESS" ${row.artefact_Process === 'PROCESS' ? 'selected' : ''}>PROCESS</option>
                `;
            }
        };

        const updateTypeOptions = (selectedCat, selectedType = null) => {
            if (!selectedCat || !config[selectedCat]) {
                selectType.innerHTML = '<option value="">-</option>';
                return;
            }
            let options = `<option value="">è«‹é¸æ“‡</option>`;
            for (let type in config[selectedCat]) {
                options += `<option value="${type}" title="${config[selectedCat][type]}" ${selectedType === type ? 'selected' : ''}>${type}</option>`;
            }
            selectType.innerHTML = options;
        };

        selectCat.onchange = (e) => {
            row.Category = e.target.value;
            row.Type = "";
            updateTypeOptions(e.target.value);
            updateAPStatus(e.target.value);
        };

        selectType.onchange = (e) => { row.Type = e.target.value; };
        selectAP.onchange = (e) => { row.artefact_Process = e.target.value; };

        // åˆå§‹åŒ–ç‹€æ…‹ (çºŒæ¨™)
        updateTypeOptions(row.Category, row.Type);
        updateAPStatus(row.Category);

        tdCat.appendChild(selectCat);
        tdType.appendChild(selectType);
        tdAP.appendChild(selectAP);

        const tdAction = document.createElement('td');
        if (index > 0) {
            const btnSame = document.createElement('button');
            btnSame.className = "btn btn-same";
            btnSame.innerText = "â†‘ åŒä¸Š";
            btnSame.onclick = () => {
                const prev = tableData[index-1];
                row.Category = prev.Category;
                row.Type = prev.Type;
                row.artefact_Process = prev.artefact_Process;
                renderTable(); 
            };
            tdAction.appendChild(btnSame);
        }

        tr.appendChild(tdCat);
        tr.appendChild(tdType);
        tr.appendChild(tdAP);
        tr.appendChild(tdAction);
        tbody.appendChild(tr);
    });
}

function exportToExcel() {
    if (tableData.length === 0) return alert("æ²’æœ‰è³‡æ–™");
    const ws = XLSX.utils.json_to_sheet(tableData, {
        header: ["id", "start_time", "end_time", "text", "Category", "Type", "artefact_Process"]
    });
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Final_Result");
    XLSX.writeFile(wb, `annotated_${new Date().getTime()}.xlsx`);
}
</script>
</body>
</html>

