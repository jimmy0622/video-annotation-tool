<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Transcript Annotation Tool - V4</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* æ•´é«”åŸºç¤æ¨£å¼ */
        body { font-family: sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* --- ä¸Šæ–¹æ¨™è¨»æŒ‡å¼•åƒè€ƒè¡¨æ¨£å¼ --- */
        .guideline-section { margin-bottom: 25px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; }
        .guideline-header { background: #607d8b; color: white; padding: 10px 15px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; }
        .guideline-content { padding: 15px; overflow-x: auto; background: #fff; }
        .ref-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .ref-table th, .ref-table td { border: 1px solid #eee; padding: 8px; text-align: left; }
        .ref-table th { background-color: #f8f9fa; color: #555; }
        .tag-cat { font-weight: bold; color: #2e7d32; }
        .tag-type { font-weight: bold; color: #1565c0; }

        /* --- ä¸‹æ–¹æ¨™è¨»åŠŸèƒ½å€æ¨£å¼ (ä¿ç•™ä½ åŸå§‹è¦æ±‚çš„æ¨£å¼) --- */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; overflow: hidden; }
        th { background-color: #4CAF50; color: white; position: sticky; top: 0; z-index: 10; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f1f1f1; }
        select { width: 100%; padding: 5px; border-radius: 4px; cursor: pointer; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        .btn { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold; transition: 0.2s; }
        .btn-upload { background-color: #2196F3; }
        .btn-download { background-color: #f44336; }
        .btn-same { background-color: #ff9800; font-size: 12px; white-space: nowrap; }
        
        /* æ¬„ä½å¯¬åº¦è¨­å®š */
        .col-id { width: 40px; }
        .col-time { width: 100px; }
        .col-text { width: 35%; }
        .col-select { width: 150px; }
        .col-action { width: 80px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h2>Transcript æ¨™è¨»ç³»çµ±</h2>

    <div class="guideline-section">
        <div class="guideline-header" onclick="toggleGuideline()">
            <span>ğŸ“– æ¨™è¨»æŒ‡å¼•åƒè€ƒè¡¨ (Annotation Guidelines)</span>
            <span id="toggleIcon">â–¼ æ”¶åˆ</span>
        </div>
        <div class="guideline-content" id="guidelineContent">
            <table class="ref-table">
                <thead>
                    <tr>
                        <th style="width:10%">Category</th>
                        <th style="width:10%">Type</th>
                        <th style="width:35%">Definition</th>
                        <th style="width:45%">Example from Dataset</th>
                    </tr>
                </thead>
                <tbody id="guidelineBody">
                    </tbody>
            </table>
        </div>
    </div>
    
    <div class="controls">
        <input type="file" id="upload" accept=".xlsx, .xls" style="display:none">
        <button class="btn btn-upload" onclick="document.getElementById('upload').click()">è®€å– Excel æª”æ¡ˆ</button>
        <button class="btn btn-download" onclick="exportToExcel()">åŒ¯å‡ºæ¨™è¨»çµæœ (.xlsx)</button>
        <span id="fileNameDisplay" style="color: #666;">å°šæœªè®€å–æª”æ¡ˆ</span>
    </div>

    <table id="dataTable">
        <thead>
            <tr>
                <th class="col-id">ID</th>
                <th class="col-time">Start</th>
                <th class="col-time">End</th>
                <th class="col-text">Text</th>
                <th class="col-select">Category</th>
                <th class="col-select">Type</th>
                <th class="col-action">å¿«æ·</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
    </table>
</div>

<script>
// 1. å®Œæ•´çš„æŒ‡å¼•è³‡æ–™é…ç½®
const fullConfigData = [
    { cat: "Greeting", type: "Opening", def: "Starting remarks and instructor/channel introductions", ex: "\"Hey, what's up you guys, Chef [...] here.\"" },
    { cat: "Greeting", type: "Closing", def: "Parting remarks and wrap-up", ex: "\"Stay tuned, we'll catch you all later.\"" },
    { cat: "Overview", type: "Goal", def: "Main purpose of the video and its descriptions", ex: "\"Today, I'll show you a special technique...\"" },
    { cat: "Overview", type: "Motivation", def: "Reasons or background information", ex: "\"[...] Someone is making a very special valentine's day meal...\"" },
    { cat: "Overview", type: "Briefing", def: "Rundown of how the goal will be achieved", ex: "\"I'm pretty sure that just taking a pencil...\"" },
    { cat: "Method", type: "Subgoal", def: "Objective of a subsection", ex: "\"Now for the intricate layer...\"" },
    { cat: "Method", type: "Instruction", def: "Actions performed to complete the task", ex: "\"We're going to pour that into our silicone baking cups.\"" },
    { cat: "Method", type: "Tool", def: "Materials, ingredients, and equipment", ex: "\"I'm also going to use a pair of scissors...\"" },
    { cat: "Supplementary", type: "Tip", def: "Additional info to make instruction efficient", ex: "\"I find that it's easier to do just a couple of layers...\"" },
    { cat: "Supplementary", type: "Warning", def: "Actions that should be avoided", ex: "\"I don't know but I would say avoid using bleach...\"" },
    { cat: "Explanation", type: "Justification", def: "Reasons why the instruction was performed", ex: "\"Because every time we wear our contact lenses...\"" },
    { cat: "Explanation", type: "Effect", def: "Consequences of the instruction", ex: "\"And these will overhang a little to help hide the gap.\"" },
    { cat: "Description", type: "Status", def: "Current state of the target object", ex: "\"Something sticky and dirty all through the back seat.\"" },
    { cat: "Description", type: "Context", def: "Descriptions of the method or setting", ex: "\"[...] The process of putting on a tip by hand...\"" },
    { cat: "Description", type: "Tool Specification", def: "Descriptions of the tools", ex: "\"These are awesome beans, creamy texture...\"" },
    { cat: "Conclusion", type: "Outcome", def: "Final results of the procedure", ex: "\"And now we have a dinosaur taggy blanket...\"" },
    { cat: "Conclusion", type: "Reflection", def: "Summary/Suggestions for the future", ex: "\"However, I am still concerned about how safe...\"" },
    { cat: "Miscellaneous", type: "Side Note", def: "Personal stories, jokes, ads", ex: "\"Tristan is back from basketball...\"" },
    { cat: "Miscellaneous", type: "Self-promotion", def: "Likes, sub, donations", ex: "\"So if you like this video, please give it a thumbs up...\"" },
    { cat: "Miscellaneous", type: "Bridge", def: "Phrases that connect different sections", ex: "\"And we're going to go ahead and get started.\"" },
    { cat: "Miscellaneous", type: "Filler", def: "Conventional filler words", ex: "\"Whoops.\"" }
];

// è½‰åŒ–ç‚ºä¸‹æ‹‰é¸å–®ç”¨çš„ Config æ ¼å¼
const config = {};
fullConfigData.forEach(item => {
    if(!config[item.cat]) config[item.cat] = {};
    config[item.cat][item.type] = item.def;
});

// åˆå§‹åŒ–æŒ‡å¼•è¡¨æ ¼ (ç”± JS ç”Ÿæˆä»¥ä¿æŒ HTML ä¹¾æ·¨)
const gBody = document.getElementById('guidelineBody');
fullConfigData.forEach(item => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="tag-cat">${item.cat}</td><td class="tag-type">${item.type}</td><td>${item.def}</td><td style="color:#666; font-style:italic">${item.ex}</td>`;
    gBody.appendChild(tr);
});

function toggleGuideline() {
    const content = document.getElementById('guidelineContent');
    const icon = document.getElementById('toggleIcon');
    if (content.style.display === "none") {
        content.style.display = "block";
        icon.innerText = "â–¼ æ”¶åˆ";
    } else {
        content.style.display = "none";
        icon.innerText = "â–² å±•é–‹åƒè€ƒè¡¨";
    }
}

let tableData = [];

// è™•ç†æª”æ¡ˆä¸Šå‚³
document.getElementById('upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById('fileNameDisplay').innerText = file.name;
    const reader = new FileReader();
    reader.onload = function(event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        tableData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        renderTable();
    };
    reader.readAsArrayBuffer(file);
});

// æ¸²æŸ“æ¨™è¨»è¡¨æ ¼
function renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';

    tableData.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.id || index + 1}</td>
            <td>${row.start_time || ''}</td>
            <td>${row.end_time || ''}</td>
            <td>${row.text || ''}</td>
        `;

        const tdCat = document.createElement('td');
        const selectCat = document.createElement('select');
        selectCat.id = `cat-${index}`;
        selectCat.innerHTML = `<option value="">è«‹é¸æ“‡</option>` + 
            Object.keys(config).map(cat => `<option value="${cat}" ${row.Category === cat ? 'selected' : ''}>${cat}</option>`).join('');
        
        const tdType = document.createElement('td');
        const selectType = document.createElement('select');
        selectType.id = `type-${index}`;
        
        const updateTypeOptions = (selectedCat, selectedType = null) => {
            if (!selectedCat || !config[selectedCat]) {
                selectType.innerHTML = '<option value="">-</option>';
                return;
            }
            let options = `<option value="">è«‹é¸æ“‡</option>`;
            for (let type in config[selectedCat]) {
                options += `<option value="${type}" title="${config[selectedCat][type]}" ${selectedType === type ? 'selected' : ''}>${type}</option>`;
            }
            selectType.innerHTML = options;
        };

        selectCat.onchange = (e) => {
            row.Category = e.target.value;
            row.Type = "";
            updateTypeOptions(e.target.value);
        };

        selectType.onchange = (e) => {
            row.Type = e.target.value;
        };

        updateTypeOptions(row.Category, row.Type);
        tdCat.appendChild(selectCat);
        tdType.appendChild(selectType);

        const tdAction = document.createElement('td');
        if (index > 0) {
            const btnSame = document.createElement('button');
            btnSame.className = "btn btn-same";
            btnSame.innerText = "â†‘ åŒä¸Š";
            btnSame.onclick = () => copyFromAbove(index);
            tdAction.appendChild(btnSame);
        }

        tr.appendChild(tdCat);
        tr.appendChild(tdType);
        tr.appendChild(tdAction);
        tbody.appendChild(tr);
    });
}

function copyFromAbove(index) {
    if (index === 0) return;
    const prevRow = tableData[index - 1];
    tableData[index].Category = prevRow.Category;
    tableData[index].Type = prevRow.Type;

    const selectCat = document.getElementById(`cat-${index}`);
    const selectType = document.getElementById(`type-${index}`);
    
    selectCat.value = prevRow.Category || "";
    selectCat.dispatchEvent(new Event('change')); 
    
    setTimeout(() => {
        selectType.value = prevRow.Type || "";
        tableData[index].Type = prevRow.Type;
    }, 5);
}

function exportToExcel() {
    if (tableData.length === 0) return alert("æ²’æœ‰è³‡æ–™");
    const ws = XLSX.utils.json_to_sheet(tableData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Annotated");
    XLSX.writeFile(wb, `annotated_${new Date().getTime()}.xlsx`);
}
</script>

</body>
</html>